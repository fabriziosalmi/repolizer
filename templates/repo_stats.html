<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repolizer - Repository Statistics</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .score-card {
            transition: all 0.3s ease;
        }
        .score-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .score-bar {
            height: 8px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .score-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        /* Score color gradients */
        .score-high {
            background-color: #34d399;
        }
        .score-medium {
            background-color: #fbbf24;
        }
        .score-low {
            background-color: #f87171;
        }
        /* Category badge styles */
        .category-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            display: inline-block;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }
        /* Check list styles */
        .check-item {
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .check-item:hover {
            border-left-color: #3b82f6;
            background-color: #f9fafb;
        }
        /* Add loading indicator style */
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 4rem 0;
            font-size: 1.2rem;
            color: #4b5563; /* gray-600 */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6; /* blue-500 */
            animation: spin 1s ease infinite;
            margin-right: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-gray-800 text-white shadow-lg">
        <div class="container mx-auto p-4 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fab fa-github text-4xl mr-3"></i>
                <h1 class="text-2xl font-bold">Repolizer</h1>
            </div>
            <!-- Updated navigation menu -->
            <div class="flex items-center space-x-4">
                <a href="/" class="text-white hover:text-blue-300 transition-colors">
                    <i class="fas fa-home mr-1"></i> Home
                </a>
                {% if current_user.is_authenticated %}
                    <a href="/scraper" class="text-white hover:text-blue-300 transition-colors">
                        <i class="fas fa-search mr-1"></i> Scraper
                    </a>
                    <a href="/analyze" class="text-white hover:text-blue-300 transition-colors">
                        <i class="fas fa-chart-line mr-1"></i> Analyzer
                    </a>
                {% endif %}
                <a href="/stats" class="text-blue-300 border-b-2 border-blue-300"> <!-- Active link style -->
                    <i class="fas fa-chart-pie mr-1"></i> Statistics
                </a>
                <!-- Login/Logout Link -->
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('logout') }}" class="text-white hover:text-red-400 transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="text-white hover:text-blue-300 transition-colors">
                        <i class="fas fa-sign-in-alt mr-1"></i> Login
                    </a>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4">
        <div id="loading">
             <div class="spinner"></div>
             <span>Loading statistics...</span>
        </div>

        <div id="stats-container" class="hidden">
            <!-- Overall Stats Summary -->
            <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Repository Analysis Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Total Repositories Card -->
                    <div class="score-card bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-sm text-gray-500 uppercase tracking-wide">Total Repositories</h3>
                                <p id="total-repos" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-database text-blue-500 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Average Overall Score Card -->
                    <div class="score-card bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-sm text-gray-500 uppercase tracking-wide">Average Score</h3>
                                <p id="avg-score" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-chart-line text-green-500 text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="score-bar">
                                <div id="avg-score-bar" class="score-bar-fill score-medium" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Languages Count Card -->
                    <div class="score-card bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-sm text-gray-500 uppercase tracking-wide">Languages</h3>
                                <p id="languages-count" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full">
                                <i class="fas fa-code text-purple-500 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Checks Card -->
                    <div class="score-card bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-sm text-gray-500 uppercase tracking-wide">Total Checks</h3>
                                <p id="checks-count" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i class="fas fa-tasks text-yellow-500 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Category Average Scores Chart -->
                <div class="bg-white rounded-lg shadow-md p-5">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Category Average Scores</h3>
                    <div class="h-80">
                        <canvas id="category-scores-chart"></canvas>
                    </div>
                </div>
                
                <!-- Language Distribution Chart -->
                <div class="bg-white rounded-lg shadow-md p-5">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Language Distribution</h3>
                    <div class="h-80">
                        <canvas id="language-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Score Distribution -->
            <div class="bg-white rounded-lg shadow-md p-5 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Score Distribution</h3>
                <div class="h-64">
                    <canvas id="score-distribution-chart"></canvas>
                </div>
            </div>
            
            <!-- Category Details Section -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="p-5 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800">Category Details</h3>
                    <p class="text-gray-600">Performance of repositories across different health categories</p>
                </div>
                <div class="p-5">
                    <div id="category-details" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Category cards will be inserted here dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Repository Checks Section -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-5 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800">Available Checks</h3>
                    <p class="text-gray-600">List of all repository health checks by category</p>
                </div>
                <div class="p-5">
                    <div id="check-details" class="space-y-6">
                        <!-- Check lists will be inserted here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <div id="error-container" class="hidden text-center py-12">
            <i class="fas fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
            <p class="text-xl text-gray-600">Error loading repository data. Please make sure your results.jsonl file is accessible.</p>
        </div>
    </main>

    <footer class="bg-gray-800 text-white mt-auto py-6">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; {{ current_year }} Repolizer</p> <!-- Use context variable -->
        </div>
    </footer>

    <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // Get DOM elements
    const statsContainer = document.getElementById('stats-container');
    const loadingIndicator = document.getElementById('loading');
    const errorContainer = document.getElementById('error-container');

    if (!statsContainer || !loadingIndicator || !errorContainer) {
      console.error('Required DOM elements not found');
      return;
    }

    // Show loading indicator
    loadingIndicator.style.display = 'flex';
    statsContainer.classList.add('hidden');
    errorContainer.classList.add('hidden');

    // Create the initial structure for the stats page
    statsContainer.innerHTML = `
      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Repository Health Overview</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-blue-50 p-4 rounded-lg shadow-sm">
            <h3 class="text-lg font-semibold text-blue-700 mb-2">Analyzed Repositories</h3>
            <p class="text-3xl font-bold text-blue-800" id="total-repos">Loading...</p>
          </div>
          <div class="bg-green-50 p-4 rounded-lg shadow-sm">
            <h3 class="text-lg font-semibold text-green-700 mb-2">Average Health Score</h3>
            <p class="text-3xl font-bold text-green-800" id="average-score">Loading...</p>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg shadow-sm">
            <h3 class="text-lg font-semibold text-purple-700 mb-2">Most Common Issues</h3>
            <p class="text-md text-purple-800" id="common-issues">Loading...</p>
          </div>
        </div>

        <h3 class="text-xl font-bold text-gray-800 mb-3">Category Scores</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" id="category-details">
          <div class="bg-gray-100 p-4 rounded-lg shadow-sm animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-8 bg-gray-200 rounded mb-1"></div>
            <div class="h-2 bg-gray-200 rounded mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          </div>
          <div class="bg-gray-100 p-4 rounded-lg shadow-sm animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-8 bg-gray-200 rounded mb-1"></div>
            <div class="h-2 bg-gray-200 rounded mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          </div>
          <div class="bg-gray-100 p-4 rounded-lg shadow-sm animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-8 bg-gray-200 rounded mb-1"></div>
            <div class="h-2 bg-gray-200 rounded mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          </div>
        </div>
      </div>
    `;

    // Now get references to newly created elements
    const totalRepos = document.getElementById('total-repos');
    const avgScore = document.getElementById('average-score');
    const commonIssues = document.getElementById('common-issues');
    const categoryDetailsContainer = document.getElementById('category-details');
    const checkDetailsContainer = document.getElementById('check-details');

    // Category icons and names
    const categoryIcons = {
      'documentation': 'fa-file-lines',
      'security': 'fa-shield-alt',
      'code_quality': 'fa-code',
      'performance': 'fa-tachometer-alt',
      'accessibility': 'fa-universal-access',
      'ci_cd': 'fa-sync',
      'maintainability': 'fa-wrench',
      'testing': 'fa-vial',
      'licensing': 'fa-balance-scale',
      'community': 'fa-users'
    };

    const categoryNames = {
      'documentation': 'Documentation',
      'security': 'Security',
      'code_quality': 'Code Quality',
      'performance': 'Performance',
      'accessibility': 'Accessibility',
      'ci_cd': 'CI/CD',
      'maintainability': 'Maintainability',
      'testing': 'Testing',
      'licensing': 'Licensing',
      'community': 'Community'
    };

    try {
      console.log("Fetching statistics data...");
      
      // Get statistics from the API with timeout to prevent hanging requests
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
      
      const response = await fetch('/api/statistics', {
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
      }
      
      const stats = await response.json();
      console.log("Fetched statistics data:", stats);

      // Check for API errors
      if (stats.error) {
        throw new Error(stats.error);
      }

      // Explicitly hide loading indicator and show stats container
      loadingIndicator.style.display = 'none';
      loadingIndicator.classList.add('hidden');
      statsContainer.classList.remove('hidden');

      // Process and display stats
      if (!stats || typeof stats !== 'object') {
        throw new Error('Invalid statistics data received');
      }

      // Update metrics
      if (totalRepos) {
        totalRepos.textContent = stats.total_repositories || 0;
      }
      
      if (avgScore) {
        const avgScoreValue = stats.average_overall_score || 0;
        avgScore.textContent = avgScoreValue.toFixed(1);
      }

      // Set common issues
      if (commonIssues) {
        if (stats.common_issues && stats.common_issues.length > 0) {
          commonIssues.innerHTML = stats.common_issues.slice(0, 3).map(issue => 
            `<div class="mb-1">â€¢ ${issue}</div>`
          ).join('');
        } else {
          commonIssues.textContent = 'No common issues found';
        }
      }

      // Update category details
      if (categoryDetailsContainer) {
        categoryDetailsContainer.innerHTML = '';
        
        // Get category scores
        const categoryScores = stats.category_average_scores || {};
        
        Object.entries(categoryScores).forEach(([category, avgScore]) => {
          if (!categoryNames[category]) return;
          
          const score = avgScore || 0;
          const scoreFormatted = score.toFixed(1);
          const scoreClass = score >= 70 ? 'score-high' : (score >= 40 ? 'score-medium' : 'score-low');
          const icon = categoryIcons[category] || 'fa-question-circle';
          const displayName = categoryNames[category] || category;
          const repoCount = stats.category_repo_counts?.[category] || 0;
          const percentage = stats.total_repositories > 0 ? 
            Math.round((repoCount / stats.total_repositories) * 100) : 0;

          const card = document.createElement('div');
          card.className = 'score-card bg-white border rounded-lg p-4 shadow-sm';
          card.innerHTML = `
            <div class="flex items-center mb-2">
              <i class="fas ${icon} mr-2 text-lg ${scoreClass.replace('score-', 'text-').replace('high', 'green-500').replace('medium', 'yellow-500').replace('low', 'red-500')}"></i>
              <h4 class="font-semibold text-gray-700">${displayName}</h4>
            </div>
            <p class="text-2xl font-bold mb-1 ${scoreClass.replace('score-', 'text-').replace('high', 'green-500').replace('medium', 'yellow-500').replace('low', 'red-500')}">${scoreFormatted}</p>
            <div class="score-bar w-full bg-gray-200 rounded-full mb-2">
              <div class="score-bar-fill ${scoreClass} rounded-full" style="width: ${score}%;"></div>
            </div>
            <p class="text-xs text-gray-500">${repoCount.toLocaleString()} / ${stats.total_repositories.toLocaleString()} Repos (${percentage}%)</p>
          `;
          categoryDetailsContainer.appendChild(card);
        });
      }

    } catch (error) {
      console.error('Error loading statistics data:', error);
      
      // Make sure loading indicator is hidden and error is shown
      loadingIndicator.style.display = 'none';
      loadingIndicator.classList.add('hidden');
      statsContainer.classList.add('hidden');
      
      if (errorContainer) {
        errorContainer.classList.remove('hidden');
        
        const errorMessage = errorContainer.querySelector('p');
        if (errorMessage) {
          errorMessage.textContent = `Failed to load statistics data: ${error.message}`;
        }
      }
    }
  });
</script>
</body>
</html>
