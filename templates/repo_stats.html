<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repolizer - Repository Statistics</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .score-card {
            transition: all 0.3s ease;
        }
        .score-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .score-bar {
            height: 8px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .score-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        /* Score color gradients */
        .score-high {
            background-color: #34d399;
        }
        .score-medium {
            background-color: #fbbf24;
        }
        .score-low {
            background-color: #f87171;
        }
        /* Category badge styles */
        .category-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            display: inline-block;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }
        /* Check list styles */
        .check-item {
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .check-item:hover {
            border-left-color: #3b82f6;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-gray-800 text-white shadow-lg">
        <div class="container mx-auto p-4 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fab fa-github text-4xl mr-3"></i>
                <h1 class="text-2xl font-bold">Repolizer</h1>
            </div>
            <!-- Navigation menu -->
            <div class="flex items-center space-x-4">
                <a href="/" class="text-white hover:text-blue-300 transition-colors">
                    <i class="fas fa-home mr-1"></i> Home
                </a>
                <a href="/scraper" class="text-white hover:text-blue-300 transition-colors">
                    <i class="fas fa-search mr-1"></i> Scraper
                </a>
                <a href="/analyze" class="text-white hover:text-blue-300 transition-colors">
                    <i class="fas fa-chart-line mr-1"></i> Analyzer
                </a>
                <a href="/stats" class="text-blue-300 border-b-2 border-blue-300">
                    <i class="fas fa-chart-pie mr-1"></i> Statistics
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4">
        <div id="loading" class="flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>

        <div id="stats-container" class="hidden">
            <!-- Overall Stats Summary -->
            <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Repository Analysis Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Total Repositories Card -->
                    <div class="score-card bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-sm text-gray-500 uppercase tracking-wide">Total Repositories</h3>
                                <p id="total-repos" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-database text-blue-500 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Average Overall Score Card -->
                    <div class="score-card bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-sm text-gray-500 uppercase tracking-wide">Average Score</h3>
                                <p id="avg-score" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-chart-line text-green-500 text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="score-bar">
                                <div id="avg-score-bar" class="score-bar-fill score-medium" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Languages Count Card -->
                    <div class="score-card bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-sm text-gray-500 uppercase tracking-wide">Languages</h3>
                                <p id="languages-count" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full">
                                <i class="fas fa-code text-purple-500 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Checks Card -->
                    <div class="score-card bg-white rounded-lg shadow-md p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-sm text-gray-500 uppercase tracking-wide">Total Checks</h3>
                                <p id="checks-count" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i class="fas fa-tasks text-yellow-500 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Category Average Scores Chart -->
                <div class="bg-white rounded-lg shadow-md p-5">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Category Average Scores</h3>
                    <div class="h-80">
                        <canvas id="category-scores-chart"></canvas>
                    </div>
                </div>
                
                <!-- Language Distribution Chart -->
                <div class="bg-white rounded-lg shadow-md p-5">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Language Distribution</h3>
                    <div class="h-80">
                        <canvas id="language-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Score Distribution -->
            <div class="bg-white rounded-lg shadow-md p-5 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Score Distribution</h3>
                <div class="h-64">
                    <canvas id="score-distribution-chart"></canvas>
                </div>
            </div>
            
            <!-- Category Details Section -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="p-5 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800">Category Details</h3>
                    <p class="text-gray-600">Performance of repositories across different health categories</p>
                </div>
                <div class="p-5">
                    <div id="category-details" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Category cards will be inserted here dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Repository Checks Section -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-5 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800">Available Checks</h3>
                    <p class="text-gray-600">List of all repository health checks by category</p>
                </div>
                <div class="p-5">
                    <div id="check-details" class="space-y-6">
                        <!-- Check lists will be inserted here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <div id="error-container" class="hidden text-center py-12">
            <i class="fas fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
            <p class="text-xl text-gray-600">Error loading repository data. Please make sure your results.jsonl file is accessible.</p>
        </div>
    </main>

    <footer class="bg-gray-800 text-white mt-auto py-6">
        <div class="container mx-auto px-4 text-center">
            <p>Repolizer</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingIndicator = document.getElementById('loading');
            const statsContainer = document.getElementById('stats-container');
            const errorContainer = document.getElementById('error-container');
            
            // Category definitions (icons and display names)
            const categoryNames = {
                'documentation': 'Documentation',
                'security': 'Security',
                'code_quality': 'Code Quality',
                'performance': 'Performance',
                'accessibility': 'Accessibility', 
                'ci_cd': 'CI/CD',
                'maintainability': 'Maintainability',
                'testing': 'Testing',
                'licensing': 'Licensing',
                'community': 'Community'
            };
            
            const categoryIcons = {
                'documentation': 'fa-file-lines',
                'security': 'fa-shield-alt',
                'code_quality': 'fa-code',
                'performance': 'fa-tachometer-alt',
                'accessibility': 'fa-universal-access',
                'ci_cd': 'fa-sync',
                'maintainability': 'fa-wrench',
                'testing': 'fa-vial',
                'licensing': 'fa-balance-scale',
                'community': 'fa-users'
            };
            
            // Colors for charts
            const categoryColors = {
                'documentation': '#3b82f6', // blue
                'security': '#ef4444', // red
                'code_quality': '#10b981', // green
                'performance': '#f59e0b', // amber
                'accessibility': '#8b5cf6', // purple
                'ci_cd': '#ec4899', // pink
                'maintainability': '#6366f1', // indigo
                'testing': '#14b8a6', // teal
                'licensing': '#f97316', // orange
                'community': '#84cc16' // lime
            };
            
            // Try to load repositories data
            try {
                const response = await fetch('results.jsonl');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                
                // Parse JSONL (one JSON object per line)
                const repositories = text.split('\n')
                    .filter(line => line.trim() !== '')
                    .map(line => {
                        try {
                            return JSON.parse(line);
                        } catch (e) {
                            console.error('Error parsing JSONL line:', e);
                            return null;
                        }
                    })
                    .filter(repo => repo !== null);
                
                // Hide loading and show stats
                loadingIndicator.classList.add('hidden');
                statsContainer.classList.remove('hidden');
                
                // Process stats
                calculateAndDisplayStats(repositories);
                
            } catch (error) {
                console.error('Error loading repository data:', error);
                loadingIndicator.classList.add('hidden');
                errorContainer.classList.remove('hidden');
            }
            
            // Main function to process all statistics
            function calculateAndDisplayStats(repositories) {
                // ------------------------
                // 1. Calculate basic stats
                // ------------------------
                
                // Total repositories
                const totalRepos = repositories.length;
                document.getElementById('total-repos').textContent = totalRepos;
                
                // Average overall score
                let totalScore = 0;
                let validScoreCount = 0;
                
                repositories.forEach(repo => {
                    if (repo.overall_score !== undefined && !isNaN(repo.overall_score)) {
                        totalScore += repo.overall_score;
                        validScoreCount++;
                    }
                });
                
                const avgScore = validScoreCount > 0 ? totalScore / validScoreCount : 0;
                const avgScoreFormatted = avgScore.toFixed(1);
                document.getElementById('avg-score').textContent = avgScoreFormatted;
                
                // Update average score bar
                const avgScoreBar = document.getElementById('avg-score-bar');
                avgScoreBar.style.width = `${avgScore}%`;
                
                // Change color based on score
                avgScoreBar.className = avgScore >= 70 ? 'score-bar-fill score-high' : 
                                      (avgScore >= 40 ? 'score-bar-fill score-medium' : 'score-bar-fill score-low');
                
                // Count unique languages
                const languages = new Map();
                repositories.forEach(repo => {
                    const language = repo.repository?.language;
                    if (language) {
                        languages.set(language, (languages.get(language) || 0) + 1);
                    }
                });
                document.getElementById('languages-count').textContent = languages.size;
                
                // ------------------------
                // 2. Identify and count all checks
                // ------------------------
                const categorizedChecks = {};
                let totalChecks = 0;
                
                // Initialize categories
                Object.keys(categoryNames).forEach(category => {
                    categorizedChecks[category] = new Set();
                });
                
                // Find all unique checks across all repos
                repositories.forEach(repo => {
                    Object.keys(categoryNames).forEach(category => {
                        if (repo[category] && typeof repo[category] === 'object') {
                            // Count all unique check names in this category
                            Object.keys(repo[category]).forEach(checkName => {
                                categorizedChecks[category].add(checkName);
                            });
                        }
                    });
                });
                
                // Count total unique checks
                Object.values(categorizedChecks).forEach(checks => {
                    totalChecks += checks.size;
                });
                document.getElementById('checks-count').textContent = totalChecks;
                
                // ------------------------
                // 3. Calculate category average scores
                // ------------------------
                const categoryScores = {};
                
                Object.keys(categoryNames).forEach(category => {
                    let categoryTotal = 0;
                    let categoryCount = 0;
                    
                    repositories.forEach(repo => {
                        if (repo[category] && typeof repo[category] === 'object') {
                            const checks = Object.values(repo[category]);
                            if (checks.length > 0) {
                                const checkScores = checks.map(check => check.score || 0);
                                if (checkScores.length > 0) {
                                    const sum = checkScores.reduce((total, score) => total + score, 0);
                                    categoryTotal += sum / checkScores.length;
                                    categoryCount++;
                                }
                            }
                        }
                    });
                    
                    categoryScores[category] = categoryCount > 0 ? categoryTotal / categoryCount : 0;
                });
                
                // ------------------------
                // 4. Create category score chart
                // ------------------------
                const categoryLabels = Object.keys(categoryScores).map(key => categoryNames[key]);
                const categoryData = Object.values(categoryScores).map(score => parseFloat(score.toFixed(1)));
                const categoryBackgroundColors = Object.keys(categoryScores).map(key => categoryColors[key]);
                
                new Chart(
                    document.getElementById('category-scores-chart'),
                    {
                        type: 'bar',
                        data: {
                            labels: categoryLabels,
                            datasets: [{
                                label: 'Average Score',
                                data: categoryData,
                                backgroundColor: categoryBackgroundColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Score'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    }
                );
                
                // ------------------------
                // 5. Create language distribution chart
                // ------------------------
                // Sort languages by count (descending)
                const sortedLanguages = [...languages.entries()]
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10); // Show top 10 languages
                
                const languageLabels = sortedLanguages.map(item => item[0]);
                const languageCounts = sortedLanguages.map(item => item[1]);
                
                // Generate random colors for languages
                const languageColors = languageLabels.map((_, i) => {
                    const hue = (i * 137) % 360; // Use golden angle for good distribution
                    return `hsl(${hue}, 70%, 60%)`;
                });
                
                new Chart(
                    document.getElementById('language-distribution-chart'),
                    {
                        type: 'doughnut',
                        data: {
                            labels: languageLabels,
                            datasets: [{
                                data: languageCounts,
                                backgroundColor: languageColors,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    }
                );
                
                // ------------------------
                // 6. Create score distribution chart
                // ------------------------
                // Group scores into buckets (0-10, 11-20, etc.)
                const scoreBuckets = {
                    '0-10': 0, '11-20': 0, '21-30': 0, '31-40': 0, '41-50': 0,
                    '51-60': 0, '61-70': 0, '71-80': 0, '81-90': 0, '91-100': 0
                };
                
                repositories.forEach(repo => {
                    if (repo.overall_score !== undefined && !isNaN(repo.overall_score)) {
                        const score = repo.overall_score;
                        const bucketIndex = Math.min(Math.floor(score / 10), 9);
                        const bucketKey = Object.keys(scoreBuckets)[bucketIndex];
                        scoreBuckets[bucketKey]++;
                    }
                });
                
                const scoreDistLabels = Object.keys(scoreBuckets);
                const scoreDistData = Object.values(scoreBuckets);
                
                // Color gradient from red to green
                const scoreDistColors = scoreDistLabels.map((key, i) => {
                    const r = Math.round(255 - (i * 25));
                    const g = Math.round(i * 25);
                    return `rgba(${r}, ${g}, 0, 0.7)`;
                });
                
                new Chart(
                    document.getElementById('score-distribution-chart'),
                    {
                        type: 'bar',
                        data: {
                            labels: scoreDistLabels,
                            datasets: [{
                                label: 'Repositories',
                                data: scoreDistData,
                                backgroundColor: scoreDistColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Number of Repositories'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Score Range'
                                    }
                                }
                            }
                        }
                    }
                );
                
                // ------------------------
                // 7. Generate category detail cards
                // ------------------------
                const categoryDetailsContainer = document.getElementById('category-details');
                
                Object.keys(categoryNames).forEach(category => {
                    const categoryScore = categoryScores[category] || 0;
                    const scoreFormatted = categoryScore.toFixed(1);
                    const scoreClass = categoryScore >= 70 ? 'score-high' : 
                                     (categoryScore >= 40 ? 'score-medium' : 'score-low');
                    
                    // Count repositories that have this category analyzed
                    let reposWithCategory = 0;
                    repositories.forEach(repo => {
                        if (repo[category] && Object.keys(repo[category]).length > 0) {
                            reposWithCategory++;
                        }
                    });
                    
                    // Calculate percentage
                    const percentage = totalRepos > 0 ? Math.round((reposWithCategory / totalRepos) * 100) : 0;
                    
                    const card = document.createElement('div');
                    card.className = 'score-card bg-white border rounded-lg p-4 shadow-sm';
                    card.innerHTML = `
                        <div class="flex items-center mb-2">
                            <div class="bg-${categoryColors[category].substring(1)}-100 p-2 rounded-full mr-3">
                                <i class="fas ${categoryIcons[category]} text-${categoryColors[category].substring(1)}-500"></i>
                            </div>
                            <h4 class="font-semibold text-gray-700">${categoryNames[category]}</h4>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm text-gray-500">Average Score:</span>
                                <span class="text-sm font-medium">${scoreFormatted}</span>
                            </div>
                            <div class="score-bar">
                                <div class="score-bar-fill ${scoreClass}" style="width: ${categoryScore}%"></div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500 mt-3">
                            <div class="flex justify-between">
                                <span>Analyzed in:</span>
                                <span class="font-semibold">${reposWithCategory} repositories (${percentage}%)</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span>Available checks:</span>
                                <span class="font-semibold">${categorizedChecks[category].size}</span>
                            </div>
                        </div>
                    `;
                    
                    categoryDetailsContainer.appendChild(card);
                });
                
                // ------------------------
                // 8. Generate check details
                // ------------------------
                const checkDetailsContainer = document.getElementById('check-details');
                
                Object.keys(categoryNames).forEach(category => {
                    // Skip categories with no checks
                    if (categorizedChecks[category].size === 0) return;
                    
                    const categorySection = document.createElement('div');
                    
                    // Create category header
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'mb-2 flex items-center';
                    categoryHeader.innerHTML = `
                        <i class="fas ${categoryIcons[category]} text-${categoryColors[category].substring(1)}-500 mr-2"></i>
                        <h4 class="text-lg font-semibold text-gray-700">${categoryNames[category]}</h4>
                        <span class="ml-2 bg-gray-100 text-gray-600 text-xs font-semibold px-2 py-1 rounded-full">
                            ${categorizedChecks[category].size} checks
                        </span>
                    `;
                    
                    categorySection.appendChild(categoryHeader);
                    
                    // Create check list
                    const checkList = document.createElement('div');
                    checkList.className = 'ml-6 border-l border-gray-200 pl-4 space-y-2';
                    
                    // Sort checks alphabetically
                    const sortedChecks = Array.from(categorizedChecks[category]).sort();
                    
                    // Create check items
                    sortedChecks.forEach(checkName => {
                        // Calculate average score for this check
                        let checkTotal = 0;
                        let checkCount = 0;
                        
                        repositories.forEach(repo => {
                            if (repo[category]?.[checkName]?.score !== undefined) {
                                checkTotal += repo[category][checkName].score;
                                checkCount++;
                            }
                        });
                        
                        const checkAvg = checkCount > 0 ? checkTotal / checkCount : 0;
                        const checkScoreFormatted = checkAvg.toFixed(1);
                        const checkScoreClass = checkAvg >= 70 ? 'text-green-500' : 
                                               (checkAvg >= 40 ? 'text-yellow-500' : 'text-red-500');
                        
                        // Format check name for better display
                        const displayName = checkName
                            .replace(/_/g, ' ')
                            .replace(/([A-Z])/g, ' $1')
                            .replace(/^./, str => str.toUpperCase());
                        
                        const checkItem = document.createElement('div');
                        checkItem.className = 'check-item py-2 px-3 rounded';
                        checkItem.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">${displayName}</span>
                                <span class="font-semibold ${checkScoreClass}">${checkScoreFormatted}</span>
                            </div>
                        `;
                        
                        checkList.appendChild(checkItem);
                    });
                    
                    categorySection.appendChild(checkList);
                    checkDetailsContainer.appendChild(categorySection);
                });
            }
        });
    </script>
</body>
</html>
