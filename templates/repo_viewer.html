<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Repolizer - Home</title>
    
    <!-- Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Repolizer">
    <meta name="theme-color" content="#1f2937">
    <meta name="application-name" content="Repolizer">
    <meta name="msapplication-TileColor" content="#1f2937">
    <meta name="msapplication-navbutton-color" content="#1f2937">
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Add specific styles for iOS web app */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }
        
        /* Existing styles */
        .repo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .repo-card {
            transition: all 0.3s ease;
        }
        .score-bar {
            height: 20px;
            border-radius: 9999px;
            position: relative;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .score-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease;
        }
        /* Score color gradients */
        .score-high {
            background-color: #34d399;
        }
        .score-medium {
            background-color: #fbbf24;
        }
        .score-low {
            background-color: #f87171;
        }
        /* Category badge styles */
        .category-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            display: inline-block;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }
        /* Add loading indicator style */
        #loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 4rem 0;
            font-size: 1.2rem;
            color: #4b5563; /* gray-600 */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6; /* blue-500 */
            animation: spin 1s ease infinite;
            margin-right: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for no results */
        #no-results {
            text-align: center;
            padding: 4rem 0;
            color: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-gray-800 text-white shadow-lg">
        <div class="container mx-auto p-4 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fab fa-github text-4xl mr-3"></i>
                <h1 class="text-2xl font-bold">Repolizer</h1>
            </div>
            <!-- Updated navigation menu -->
            <div class="flex items-center space-x-4">
                <a href="/" class="text-blue-300 border-b-2 border-blue-300"> <!-- Active link style -->
                    <i class="fas fa-home mr-1"></i> Home
                </a>
                {% if current_user.is_authenticated %}
                    <a href="/scraper" class="text-white hover:text-blue-300 transition-colors">
                        <i class="fas fa-search mr-1"></i> Scraper
                    </a>
                    <a href="/analyze" class="text-white hover:text-blue-300 transition-colors">
                        <i class="fas fa-chart-line mr-1"></i> Analyzer
                    </a>
                {% endif %}
                <a href="/stats" class="text-white hover:text-blue-300 transition-colors">
                    <i class="fas fa-chart-pie mr-1"></i> Statistics
                </a>
                <!-- Login/Logout Link -->
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('logout') }}" class="text-white hover:text-red-400 transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="text-white hover:text-blue-300 transition-colors">
                        <i class="fas fa-sign-in-alt mr-1"></i> Login
                    </a>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4">
        <!-- Updated search/sort/filter controls - all in one row -->
        <div class="mb-6 bg-white rounded-lg shadow-md p-4">
            <div class="flex flex-wrap items-center gap-2">
                <!-- Search input - adaptive width -->
                <div class="relative w-full sm:w-64 lg:w-72">
                    <input id="search-input" type="text" placeholder="Search repositories..."
                           class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                    <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                </div>
                
                <!-- Sort dropdown -->
                <select id="sort-select" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">
                    <option value="overall_score_desc">Sort by Overall Score (High to Low)</option>
                    <option value="overall_score_asc">Sort by Overall Score (Low to High)</option>
                    <option value="stars">Sort by Stars</option>
                    <option value="forks">Sort by Forks</option>
                    <option value="updated">Sort by Updated</option>
                    <option value="name">Sort by Name</option>
                </select>

                <!-- Filters now on same line -->
                <div class="flex items-center flex-wrap gap-2">
                    <span class="text-xs text-gray-600 font-medium hidden sm:inline">Filters:</span>
                    
                    <!-- Language Filter Dropdown -->
                    <select id="language-filter-select" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">
                        <option value="all">All Languages</option>
                        <option value="Python">Python</option>
                        <option value="JavaScript">JavaScript</option>
                        <option value="Java">Java</option>
                        <option value="Go">Go</option>
                        <option value="TypeScript">TypeScript</option>
                    </select>

                    <!-- Category Filter Dropdown -->
                    <select id="category-filter-select" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">
                        <option value="all">All Categories</option>
                        <option value="documentation">Documentation</option>
                        <option value="security">Security</option>
                        <option value="code_quality">Code Quality</option>
                        <option value="performance">Performance</option>
                        <option value="accessibility">Accessibility</option>
                        <option value="ci_cd">CI/CD</option>
                        <option value="maintainability">Maintainability</option>
                        <option value="testing">Testing</option>
                        <option value="licensing">Licensing</option>
                        <option value="community">Community</option>
                    </select>

                    <!-- Min Score Filter Dropdown -->
                    <select id="score-filter-select" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">
                        <option value="0">Min Score: 0+</option>
                        <option value="25">Min Score: 25+</option>
                        <option value="50">Min Score: 50+</option>
                        <option value="75">Min Score: 75+</option>
                        <option value="90">Min Score: 90+</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="mb-6 flex justify-between items-center"> <!-- Simple container for title and count -->
            <h2 class="text-xl font-bold text-gray-800">Repository Health Analysis</h2>
            <div class="text-sm text-gray-600">
                <span id="repo-count" class="font-semibold">0</span> repositories found
            </div>
        </div>

        <div id="loading-indicator">
            <div class="spinner"></div>
            <span>Loading repositories...</span>
        </div>

        <div id="repo-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Repository cards will be dynamically inserted here -->
        </div>

        <div id="no-results" class="hidden">
            <i class="fas fa-search text-gray-400 text-5xl mb-4"></i>
            <p class="text-xl text-gray-600">No repositories found matching your search criteria.</p>
        </div>
        <!-- Pagination container will be added here by JS -->
    </main>

    <footer class="bg-gray-800 text-white mt-auto py-6">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; {{ current_year }} Repolizer</p> <!-- Use context variable -->
        </div>
    </footer>

    <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // Global variables
    let allRepos = [];
    let filteredRepos = [];
    let currentLanguage = 'all';
    let currentCategory = 'all';
    let minScoreFilter = 0;
    let currentPage = 1;
    const reposPerPage = 30;

    // Get elements from the DOM
    const reposContainer = document.getElementById('repo-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noResults = document.getElementById('no-results');
    const repoCount = document.getElementById('repo-count');
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const languageFilterSelect = document.getElementById('language-filter-select');
    const categoryFilterSelect = document.getElementById('category-filter-select');
    const scoreFilterSelect = document.getElementById('score-filter-select');

    // Create pagination container dynamically
    const paginationContainer = document.createElement('div');
    paginationContainer.id = 'pagination-container';
    paginationContainer.className = 'flex flex-col sm:flex-row justify-center items-center my-6 space-y-2 sm:space-y-0 sm:space-x-4'; // Adjusted classes for responsiveness
    // Insert pagination container after the grid, before the footer might be better.
    const mainElement = document.querySelector('main');
    if (mainElement) {
        mainElement.appendChild(paginationContainer);
    } else {
        console.error("Could not find main element to append pagination.");
        document.body.appendChild(paginationContainer); // Fallback append to body
    }


    // Check if all required DOM elements exist
    if (!reposContainer || !loadingIndicator || !noResults || !repoCount) {
      console.error('Required DOM elements not found.');
      return;
    }

    // Category icons and names (unchanged)
    const categoryIcons = {
      'documentation': 'fa-file-lines',
      'security': 'fa-shield-alt',
      'code_quality': 'fa-code',
      'performance': 'fa-tachometer-alt',
      'accessibility': 'fa-universal-access',
      'ci_cd': 'fa-sync',
      'maintainability': 'fa-wrench',
      'testing': 'fa-vial',
      'licensing': 'fa-balance-scale',
      'community': 'fa-users'
    };

    const categoryNames = {
      'documentation': 'Documentation',
      'security': 'Security',
      'code_quality': 'Code Quality',
      'performance': 'Performance',
      'accessibility': 'Accessibility',
      'ci_cd': 'CI/CD',
      'maintainability': 'Maintainability',
      'testing': 'Testing',
      'licensing': 'Licensing',
      'community': 'Community'
    };

    // Get page from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const pageParam = urlParams.get('page');
    if (pageParam) {
      currentPage = parseInt(pageParam, 10) || 1;
    }

    console.log(`Loading repositories from API, page ${currentPage}`);

    // Load repositories from the new API endpoint
    try {
      // Show loading indicator
      if (loadingIndicator) {
        loadingIndicator.style.display = 'flex';
        loadingIndicator.classList.remove('hidden');
      }
      if (noResults) {
        noResults.classList.add('hidden');
      }

      // Fetch data from the API endpoint
      const response = await fetch('/api/repositories'); // <-- Fetch from the new API endpoint

      if (!response.ok) {
        // Try to get error message from response body
        let errorDetail = `${response.status} ${response.statusText}`;
        try {
            const errorJson = await response.json();
            errorDetail = errorJson.error || errorDetail;
        } catch (e) { /* Ignore if response body is not JSON */ }
        throw new Error(`Failed to fetch repositories: ${errorDetail}`);
      }

      // Parse the JSON response (should be an array)
      const jsonData = await response.json();

      if (!Array.isArray(jsonData)) {
          throw new Error('Invalid data format received from API. Expected an array.');
      }

      allRepos = jsonData; // <-- Assign directly, no need for line splitting/parsing

      console.log(`Loaded ${allRepos.length} repositories successfully from API.`);

      // Process each repo to calculate category averages (still needed)
      allRepos.forEach(repo => {
        // Ensure repo.repository exists
        if (!repo.repository) {
            repo.repository = {}; // Add empty object if missing
        }
        // Add category averages
        repo.category_scores = {};

        // For each category, calculate average score
        Object.keys(categoryNames).forEach(category => {
          if (repo[category] && typeof repo[category] === 'object') { // Check if category data exists and is an object
            const checks = Object.values(repo[category]).filter(check =>
              typeof check === 'object' && check !== null && 'score' in check
            );

            if (checks.length > 0) {
              const sum = checks.reduce((total, check) => total + (check.score || 0), 0);
              repo.category_scores[category] = parseFloat((sum / checks.length).toFixed(1));
            } else {
              repo.category_scores[category] = 0;
            }
          } else {
            repo.category_scores[category] = 0; // Default to 0 if category data is missing or not an object
          }
        });
      });

      filteredRepos = [...allRepos];

      if (repoCount) {
        repoCount.textContent = filteredRepos.length;
      }

      // Initial sort by overall score
      sortRepos('overall_score_desc');

      // Hide loading indicator
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
        loadingIndicator.classList.add('hidden');
      }

      // Check if there are results to display
      if (filteredRepos.length === 0) {
        if (noResults) {
          noResults.classList.remove('hidden');
          // Update message if needed
          const noResultsMsg = noResults.querySelector('p');
          if (noResultsMsg) noResultsMsg.textContent = 'No repositories found.';
        }
      } else {
        // Display the first page
        displayRepos(); // Call displayRepos which now handles pagination update internally
      }

    } catch (error) {
      console.error('Error loading repositories:', error);

      // Ensure the loading indicator is hidden
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
        loadingIndicator.classList.add('hidden');
      }

      if (noResults) {
        noResults.classList.remove('hidden');

        const errorMsg = noResults.querySelector('p');
        if (errorMsg) {
          errorMsg.textContent = `Error loading repository data: ${error.message}`;
        }
      }
    }

    // Event listeners (unchanged)
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        filterRepos();
      });
    }
    if (sortSelect) {
      sortSelect.addEventListener('change', () => {
        sortRepos(sortSelect.value);
      });
    }
    if (languageFilterSelect) {
      languageFilterSelect.addEventListener('change', () => {
        currentLanguage = languageFilterSelect.value;
        filterRepos();
      });
    }
    if (categoryFilterSelect) {
      categoryFilterSelect.addEventListener('change', () => {
        currentCategory = categoryFilterSelect.value;
        filterRepos();
      });
    }
    if (scoreFilterSelect) {
      scoreFilterSelect.addEventListener('change', () => {
        minScoreFilter = parseInt(scoreFilterSelect.value);
        filterRepos();
      });
    }

    // Function to filter repositories (unchanged logic, just uses filteredRepos)
    function filterRepos() {
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

      console.log(`Filtering repos with: Search="${searchTerm}", Language=${currentLanguage}, Category=${currentCategory}, MinScore=${minScoreFilter}`);
      console.log(`Total repos before filtering: ${allRepos.length}`);

      filteredRepos = allRepos.filter(repo => {
        // Filter by search term (repo name or description)
        const nameMatch = repo.repository?.name?.toLowerCase().includes(searchTerm) ||
          (repo.repository?.description && repo.repository.description.toLowerCase().includes(searchTerm));

        // Filter by language
        const languageMatch = currentLanguage === 'all' || repo.repository?.language === currentLanguage;

        // Filter by overall score
        const scoreMatch = (repo.overall_score || 0) >= minScoreFilter;

        // Filter by category if selected
        let categoryMatch = true;
        if (currentCategory !== 'all') {
          // Check if the selected category exists and has a score > 0
          categoryMatch = (repo.category_scores?.[currentCategory] || 0) > 0;
        }

        return nameMatch && languageMatch && scoreMatch && categoryMatch;
      });

      console.log(`Total repos after filtering: ${filteredRepos.length}`);

      // Reset to first page when filters change
      currentPage = 1;
      // Update count and display repositories
      if (repoCount) {
        repoCount.textContent = filteredRepos.length;
      }
      displayRepos(); // displayRepos now handles pagination update
    }

    // Function to sort repositories (unchanged)
    function sortRepos(sortBy) {
      switch (sortBy) {
        case 'overall_score_desc':
          filteredRepos.sort((a, b) => (b.overall_score || 0) - (a.overall_score || 0));
          break;
        case 'overall_score_asc':
          filteredRepos.sort((a, b) => (a.overall_score || 0) - (b.overall_score || 0));
          break;
        case 'stars':
          filteredRepos.sort((a, b) => (b.repository?.stargazers_count || 0) - (a.repository?.stargazers_count || 0));
          break;
        case 'forks':
          filteredRepos.sort((a, b) => (b.repository?.forks_count || 0) - (a.repository?.forks_count || 0));
          break;
        case 'updated':
          filteredRepos.sort((a, b) => {
            const dateA = a.repository?.updated_at ? new Date(a.repository.updated_at) : new Date(0);
            const dateB = b.repository?.updated_at ? new Date(b.repository.updated_at) : new Date(0);
            return dateB - dateA;
          });
          break;
        case 'name':
          filteredRepos.sort((a, b) => {
            const nameA = a.repository?.name?.toLowerCase() || '';
            const nameB = b.repository?.name?.toLowerCase() || '';
            return nameA.localeCompare(nameB);
          });
          break;
      }
      // Reset to first page after sorting
      currentPage = 1;
      displayRepos(); // displayRepos now handles pagination update
    }

    // Function to display repositories for the current page (unchanged)
    function displayRepos() {
      if (!reposContainer) return;

      // Clear the container
      reposContainer.innerHTML = '';

      if (filteredRepos.length === 0) {
        if (noResults) {
          noResults.classList.remove('hidden');
        }
        // Clear pagination if no results
        paginationContainer.innerHTML = '';
        return;
      }

      if (noResults) {
        noResults.classList.add('hidden');
      }

      // Calculate pagination
      const startIndex = (currentPage - 1) * reposPerPage;
      const endIndex = Math.min(startIndex + reposPerPage, filteredRepos.length);
      const currentPageRepos = filteredRepos.slice(startIndex, endIndex);

      // Display the current page repositories
      currentPageRepos.forEach(repo => {
        if (!repo.repository) {
          console.warn('Repository object is missing required data:', repo);
          return;
        }

        const card = createRepoCard(repo);
        reposContainer.appendChild(card);
      });

      // Update pagination controls
      updatePagination();
    }

    // Function to update pagination controls (unchanged)
    function updatePagination() {
      const totalPages = Math.ceil(filteredRepos.length / reposPerPage);

      // Clear previous pagination
      paginationContainer.innerHTML = '';

      if (totalPages <= 1) {
        return; // No pagination needed
      }

      // Create pagination controls container
      const pagination = document.createElement('div');
      pagination.className = 'flex items-center space-x-1';

      // Previous button
      const prevButton = document.createElement('button');
      prevButton.className = 'px-3 py-1 sm:px-4 sm:py-2 border rounded-md ' +
        (currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50');
      prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevButton.disabled = currentPage === 1;
      prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          displayRepos();
          window.scrollTo(0, 0); // Scroll to top
        }
      });
      pagination.appendChild(prevButton);

      // Page numbers logic (unchanged)
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      if (startPage > 1) {
        const firstButton = document.createElement('button');
        firstButton.className = 'px-3 py-1 sm:px-4 sm:py-2 border rounded-md bg-white text-blue-600 hover:bg-blue-50';
        firstButton.textContent = '1';
        firstButton.addEventListener('click', () => {
          currentPage = 1;
          displayRepos();
          window.scrollTo(0, 0); // Scroll to top
        });
        pagination.appendChild(firstButton);

        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-3 py-1 sm:px-4 sm:py-2';
          ellipsis.textContent = '...';
          pagination.appendChild(ellipsis);
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = 'px-3 py-1 sm:px-4 sm:py-2 border rounded-md ' +
          (i === currentPage ? 'bg-blue-600 text-white' : 'bg-white text-blue-600 hover:bg-blue-50');
        pageButton.textContent = i.toString();
        pageButton.addEventListener('click', () => {
          currentPage = i;
          displayRepos();
          window.scrollTo(0, 0); // Scroll to top
        });
        pagination.appendChild(pageButton);
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-3 py-1 sm:px-4 sm:py-2';
          ellipsis.textContent = '...';
          pagination.appendChild(ellipsis);
        }

        const lastButton = document.createElement('button');
        lastButton.className = 'px-3 py-1 sm:px-4 sm:py-2 border rounded-md bg-white text-blue-600 hover:bg-blue-50';
        lastButton.textContent = totalPages.toString();
        lastButton.addEventListener('click', () => {
          currentPage = totalPages;
          displayRepos();
          window.scrollTo(0, 0); // Scroll to top
        });
        pagination.appendChild(lastButton);
      }

      // Next button
      const nextButton = document.createElement('button');
      nextButton.className = 'px-3 py-1 sm:px-4 sm:py-2 border rounded-md ' +
        (currentPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-blue-600 hover:bg-blue-50');
      nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextButton.disabled = currentPage === totalPages;
      nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          displayRepos();
          window.scrollTo(0, 0); // Scroll to top
        }
      });
      pagination.appendChild(nextButton);

      // Page info text container
      const pageInfo = document.createElement('div');
      pageInfo.className = 'text-sm text-gray-600 mt-2 sm:mt-0'; // Add margin top for small screens
      pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${filteredRepos.length} repositories)`;

      // Append controls and info to the main pagination container
      paginationContainer.appendChild(pagination);
      paginationContainer.appendChild(pageInfo);


      // Update URL with current page
      const url = new URL(window.location.href);
      url.searchParams.set('page', currentPage);
      // Use replaceState to avoid polluting browser history on pagination clicks
      window.history.replaceState({ path: url.toString() }, '', url);
    }


    // Function to create a repository card (unchanged)
    function createRepoCard(repo) {
      const card = document.createElement('div');
      card.className = 'repo-card bg-white rounded-lg shadow-md overflow-hidden h-full flex flex-col';

      const repoData = repo.repository || {};

      // Format numbers
      const stars = formatNumber(repoData.stargazers_count || 0);
      const forks = formatNumber(repoData.forks_count || 0);

      // Format date (convert to relative time)
      const updatedAt = repoData.updated_at ? formatDate(repoData.updated_at) : 'unknown';

      // Truncate description
      const description = repoData.description
        ? truncateText(repoData.description, 120)
        : 'No description available';

      // Create language badge with color
      const languageColor = getLanguageColor(repoData.language);
      const languageBadge = repoData.language ?
        `<span class="inline-flex items-center">
            <span class="w-3 h-3 rounded-full mr-1" style="background-color: ${languageColor}"></span>
            ${repoData.language}
          </span>` : '';

      // Calculate overall score and determine class
      const overallScore = repo.overall_score || 0;
      const scoreClass = overallScore >= 70 ? 'score-high' : (overallScore >= 40 ? 'score-medium' : 'score-low');

      // Generate vertical bar chart HTML for category scores
      let categoryBarChartHtml = `
        <div class="category-bar-chart flex justify-between items-end h-24 mt-2 mb-3 px-1" style="margin-top: 2.5rem;">
      `;

      // Use a fixed category order instead of sorting by score
      const fixedCategoryOrder = [
        'documentation',
        'security',
        'code_quality',
        'performance',
        'accessibility',
        'testing',
        'maintainability',
        'ci_cd',
        'licensing',
        'community'
      ];

      // Add bars for each category in the fixed order
      for (const category of fixedCategoryOrder) {
        // Get the score and metadata for this category
        const score = repo.category_scores?.[category] || 0;
        const icon = categoryIcons[category] || 'fa-question-circle';
        const name = categoryNames[category] || category;

        // Determine color class based on score
        let colorClass;
        if (score >= 70) {
          colorClass = 'bg-green-500'; // Green for scores 70-100
        } else if (score >= 40) {
          colorClass = 'bg-yellow-500'; // Yellow for scores 40-69
        } else {
          colorClass = 'bg-red-500'; // Red for scores 0-39
        }

        // Calculate height based on score (0-100%)
        const heightPercentage = Math.max(5, score); // Minimum 5% height for visibility

        // Modified structure to put icons at the bottom
        categoryBarChartHtml += `
          <div class="flex flex-col items-center w-1/10 px-0.5" title="${name}: ${score.toFixed(1)}"> <!-- Added width and padding -->
            <div class="relative w-full h-20"> <!-- Use full width of parent -->
              <div class="${colorClass} absolute bottom-0 w-full rounded-t" style="height: ${heightPercentage}%;"></div>
            </div>
            <span class="text-xs mt-1 text-gray-600">${Math.round(score)}</span>
            <i class="fas ${icon} text-gray-700 mt-1 text-xs sm:text-sm"></i> <!-- Adjusted icon size -->
          </div>
        `;
      }

      categoryBarChartHtml += `</div>`;

      // Determine the target URL for the detailed report link
      // Use full_name if ID is missing (e.g., from repositories.jsonl fallback)
      const detailLinkTarget = repoData.id ? repoData.id : (repoData.full_name || '');

      card.innerHTML = `
        <div class="p-5 flex-grow">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="text-lg font-bold text-gray-800">
                <a href="${repoData.html_url || '#'}" target="_blank" class="hover:text-blue-600">
                  ${repoData.name || 'Unnamed Repository'}
                </a>
              </h3>
              <p class="text-sm text-gray-600">${repoData.full_name || ''}</p>
            </div>
            <div class="flex items-center">
              <span class="flex items-center text-sm mr-3">
                <i class="fas fa-star text-yellow-400 mr-1"></i> ${stars}
              </span>
              <span class="flex items-center text-sm">
                <i class="fas fa-code-branch text-gray-600 mr-1"></i> ${forks}
              </span>
            </div>
          </div>

          <p class="text-gray-700 mb-2" style="font-size: 0.9rem;">${description}</p>

          <!-- Category Score Bar Chart -->
          ${categoryBarChartHtml}

          <div class="mb-4">
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm font-medium text-gray-700">Repolizer score:</span>
              <span class="text-sm font-medium ${scoreClass.replace('score-', 'text-')}">${overallScore.toFixed(1)}</span>
            </div>
            <div class="score-bar">
              <div class="score-bar-fill ${scoreClass}" style="width: ${overallScore}%"></div>
            </div>
          </div>

          <div class="mt-4 text-center">
             ${detailLinkTarget ? `
               <a href="/repo/${encodeURIComponent(detailLinkTarget)}" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                 <i class="fas fa-chart-bar mr-1"></i> View Detailed Report
               </a>
             ` : `
               <span class="inline-block px-4 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed" title="Detailed report unavailable (missing ID/Name)">
                 <i class="fas fa-chart-bar mr-1"></i> View Detailed Report
               </span>
             `}
          </div>
        </div>
        <div class="bg-gray-50 px-5 py-3 flex justify-between items-center text-sm text-gray-600">
          <span class="flex items-center">
            <i class="far fa-calendar-alt mr-1"></i> Last updated: ${updatedAt}
          </span>
          ${languageBadge}
        </div>
      `;

      return card;
    }


    // Helper functions (unchanged)
    function formatNumber(num) {
      if (typeof num !== 'number') return '0';
      return num.toLocaleString();
    }

    function truncateText(text, maxLength) {
      if (!text) return '';
      if (text.length > maxLength) {
        return text.substring(0, maxLength) + '...';
      }
      return text;
    }

    function formatDate(dateString) {
      if (!dateString) return 'Unknown';

      try {
        const date = new Date(dateString);
        // More user-friendly format
        return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        console.warn('Invalid date:', dateString);
        return 'Invalid date';
      }
    }

    function getLanguageColor(language) {
      const colors = {
        'JavaScript': '#f1e05a',
        'Python': '#3572a5',
        'HTML': '#e34c26',
        'CSS': '#563d7c',
        'Java': '#b07219',
        'TypeScript': '#2b7489',
        'Ruby': '#701516',
        'Go': '#00ADD8',
        'C#': '#178600',
        'C++': '#f34b7d',
        'PHP': '#4F5D95',
        'Shell': '#89e051',
        'C': '#555555',
        'Swift': '#ffac45',
        'Kotlin': '#F18E33',
        'Rust': '#dea584',
        'Scala': '#c22d40',
        'Perl': '#0298c3',
        'Lua': '#000080',
        'Objective-C': '#438eff',
        'Dart': '#00B4AB',
        'R': '#198CE7',
        'Jupyter Notebook': '#DA5B0B'
        // Add more as needed
      };

      return colors[language] || '#8F8F8F'; // Default gray
    }
  });
</script>
</body>
</html>