<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Repolizer - Home</title>
    
    <!-- Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Repolizer">
    <meta name="theme-color" content="#1f2937">
    <meta name="application-name" content="Repolizer">
    <meta name="msapplication-TileColor" content="#1f2937">
    <meta name="msapplication-navbutton-color" content="#1f2937">
    
    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Critical CSS inlined for faster rendering -->
    <style>
        /* Critical styles for loading state and layout */
        #loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 4rem 0;
            font-size: 1.2rem;
            color: #4b5563;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #fdfdfddc; 
            animation: spin 1s ease infinite;
            margin-right: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        body {
            background-color: #00DBDE;
            background-image: linear-gradient(90deg, #00DBDE 0%, #FC00FF 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container { 
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        .hidden {
            display: none !important;
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            .repo-card {
                /* Simplify effects on mobile for better performance */
                animation: none !important;
                -webkit-animation: none !important;
                transition: transform 0.2s ease !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            }
            
            .repo-card:hover {
                transform: none !important;
                animation: none !important;
                -webkit-animation: none !important;
                outline-color: #3b82f6 !important; /* Single color instead of gradient */
                box-shadow: 0 2px 4px rgba(0,0,0,0.15) !important;
            }
            
            /* Reduce visual complexity on mobile */
            .category-bar-gradient-high,
            .category-bar-gradient-medium,
            .category-bar-gradient-low {
                background-image: none !important;
            }
            
            /* Optimize rendering performance */
            .repo-card, .score-bar, .score-bar-fill {
                will-change: auto !important; /* Disable hardware acceleration hints when not needed */
                backface-visibility: hidden; /* Reduce composite layers */
            }
            
            /* Lighter bg gradient for mobile */
            body {
                background-image: linear-gradient(90deg, #7ffcff 0%, #ffadfa 100%) !important;
            }
            
            /* Virtual scrolling container */
            #virtual-scroll-container {
                position: relative;
                width: 100%;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
            }
        }
        
        /* Virtual scrolling styles */
        .virtual-scroll-placeholder {
            width: 100%;
            contain: strict; /* Improve rendering performance */
        }
        
        /* Lightweight mobile card */
        .mobile-repo-card {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Optimize rendering */
        .hardware-accelerated {
            transform: translateZ(0);
            will-change: transform;
        }
        
        /* Loading states */
        .progressive-load {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .progressive-load.loaded {
            opacity: 1;
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            .repo-card {
                /* Simplify effects on mobile for better performance */
                animation: none !important;
                -webkit-animation: none !important;
                transition: transform 0.2s ease !important;
            }
            
            .repo-card:hover {
                transform: none !important;
                animation: none !important;
                -webkit-animation: none !important;
                outline-color: #3b82f6 !important; /* Single color instead of gradient */
            }
            
            /* Reduce visual complexity on mobile */
            .category-bar-gradient-high,
            .category-bar-gradient-medium,
            .category-bar-gradient-low {
                background-image: none !important;
            }
        }
        
        /* Safari-specific fixes */
        @supports (-webkit-touch-callout: none) {
            /* iOS Safari specific styles */
            .repo-card, .mobile-repo-card {
                /* Use transform for hardware acceleration */
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                /* Prevent blurry text */
                -webkit-font-smoothing: antialiased;
            }
            
            /* Fix iOS Safari scroll issues */
            #virtual-scroll-container {
                -webkit-overflow-scrolling: touch;
                position: relative;
                width: 100%;
                overflow-y: auto;
                /* Prevent scroll chaining */
                overscroll-behavior: none;
                -webkit-overscroll-behavior: none;
            }
            
            /* Ensure fixed positioning works as expected */
            body {
                position: relative;
                /* Fix iOS height issues */
                min-height: -webkit-fill-available;
            }
            
            /* Better touch handling */
            button, a {
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Improve animation performance */
            .progressive-load {
                will-change: opacity;
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
                perspective: 1000;
                -webkit-perspective: 1000;
            }
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            .repo-card {
                /* Simplify effects on mobile for better performance */
                animation: none !important;
                -webkit-animation: none !important;
                transition: transform 0.2s ease !important;
            }
            
            .repo-card:hover {
                transform: none !important;
                animation: none !important;
                -webkit-animation: none !important;
                outline-color: #3b82f6 !important; /* Single color instead of gradient */
            }
            
            /* Reduce visual complexity on mobile */
            .category-bar-gradient-high,
            .category-bar-gradient-medium,
            .category-bar-gradient-low {
                background-image: none !important;
            }
            
            /* Simplified iOS Safari gradient */
            body.safari-ios {
                background-image: none !important;
                background-color: #b3e5fc !important;
            }
            
            /* Optimize rendering in Safari */
            .safari-ios .repo-card, 
            .safari-ios .score-bar, 
            .safari-ios .score-bar-fill {
                will-change: auto !important;
                backface-visibility: visible !important;
                -webkit-backface-visibility: visible !important;
            }
            
            /* Prevent safari rendering issues with absolute positioning */
            .safari-ios #virtual-scroll-content > * {
                position: relative !important;
                transform: none !important;
                -webkit-transform: none !important;
                margin-bottom: 10px !important;
            }
        }
        
        /* Ultra light mode for iOS Safari with low memory */
        .safari-ios.low-memory-mode {
            background-color: #f5f5f5 !important;
        }
        
        .safari-ios.low-memory-mode .repo-card,
        .safari-ios.low-memory-mode .mobile-repo-card {
            background-image: none !important;
            background-color: white !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
        }
    </style>
    
    <!-- Custom JS for the page - defer loading -->
    <script src="/static/js/modal.js" defer></script>

    <!-- Tailwind CSS via CDN with defer strategy -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    
    <!-- Font Awesome for icons - loaded asynchronously -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    
    <!-- Non-critical styles loaded after page render -->
    <style>
        /* Add specific styles for iOS web app */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }
        
        /* Existing styles */
        .repo-card {
            transition: all 0.3s ease;
            position: relative;
            background-color: white;
            background-image: linear-gradient(135deg, #fdfdfd 0%, #dfdfdf 100%);
            border-radius: 0.5rem; /* Match the Tailwind rounded-lg class (8px) */
            outline: 5px solid transparent;
            outline-offset: -1px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Simple outline animation for card hover */
        .repo-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transform: none;
            outline: 5px solid #3b82f6; /* Blue-500 */
            border-radius: 0.5rem;
            outline-color: #3b82f6; /* Blue-500 */
            
            /* Add browser-specific animation if needed */
            animation: outlineGradient 2s linear infinite;
            -webkit-animation: outlineGradient 2s linear infinite;
        }
        
        @keyframes outlineGradient {
            0% { outline-color: #4ade80; } /* green-400 */
            25% { outline-color: #3b82f6; } /* blue-500 */
            50% { outline-color: #a855f7; } /* purple-500 */
            75% { outline-color: #f43f5e; } /* rose-500 */
            100% { outline-color: #4ade80; } /* green-400 */
        }
        
        @-webkit-keyframes outlineGradient {
            0% { outline-color: #4ade80; } /* green-400 */
            25% { outline-color: #3b82f6; } /* blue-500 */
            50% { outline-color: #a855f7; } /* purple-500 */
            75% { outline-color: #f43f5e; } /* rose-500 */
            100% { outline-color: #4ade80; } /* green-400 */
        }
        
        /* Remove previous pseudo-elements */
        .repo-card::before, .repo-card::after {
            content: none;
        }
        
        .score-bar {
            height: 20px;
            border-radius: 9999px;
            position: relative;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .score-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease;
        }
        /* Score color gradients */
        .score-high {
            background-color: #34d399;
            background-image: linear-gradient(to right, #4ade80, #34d399, #4ade80);
        }
        .score-medium {
            background-color: #fbbf24;
            background-image: linear-gradient(to right, #fcd34d, #fbbf24, #fcd34d);
        }
        .score-low {
            background-color: #f87171;
            background-image: linear-gradient(to right, #fb7185, #f87171, #fb7185);
        }
        
        /* Category gradients for vertical bars */
        .category-bar-gradient-high {
            background-image: linear-gradient(to top, rgba(167, 243, 208, 0.8), rgba(52, 211, 153, 1), rgba(167, 243, 208, 0.8));
        }
        .category-bar-gradient-medium {
            background-image: linear-gradient(to top, rgba(253, 230, 138, 0.8), rgba(251, 191, 36, 1), rgba(253, 230, 138, 0.8));
        }
        .category-bar-gradient-low {
            background-image: linear-gradient(to top, rgba(254, 202, 202, 0.8), rgba(248, 113, 113, 1), rgba(254, 202, 202, 0.8));
        }
        
        /* Border gradients */
        .border-gradient {
            position: relative;
        }
        .border-gradient::before {
            content: '';
            position: absolute;
            inset: 0;
            padding: 1px; /* Border width */
            border-radius: inherit;
            background: linear-gradient(to right, transparent, currentColor, transparent);
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            pointer-events: none;
        }
        .border-left-gradient {
            position: relative;
        }
        .border-left-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 4px;
            background: linear-gradient(to bottom, transparent, currentColor 50%, transparent);
        }
        /* Category badge styles */
        .category-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            display: inline-block;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }
        /* Add loading indicator style */
        #loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 4rem 0;
            font-size: 1.2rem;
            color: #4b5563; /* gray-600 */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #fdfdfddc; 
            animation: spin 1s ease infinite;
            margin-right: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for no results */
        #no-results {
            text-align: center;
            padding: 4rem 0;
            color: #6b7280; /* gray-500 */
        }

        /* Corrected blur effect to exclude modal */
        body.blur-background > *:not(#share-modal) {
            filter: blur(5px);
            transition: filter 0.3s ease;
        }

        /* Ensure modal itself is not blurred */
        #share-modal {
            filter: none !important;
        }

        /* Full Report Coming Soon modal styles */
        #coming-soon-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        #coming-soon-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .coming-soon-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 500px;
            text-align: center;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        
        #coming-soon-modal.active .coming-soon-content {
            transform: scale(1);
        }
        
        .coming-soon-content h3 {
            margin-top: 0;
            color: #4F46E5;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .coming-soon-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9CA3AF;
            transition: color 0.2s;
        }
        
        .coming-soon-close:hover {
            color: #4B5563;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col" style="background-color: #00DBDE; background-image: linear-gradient(90deg, #00DBDE 0%, #FC00FF 100%);">
    <!-- Share Modal - Added for better share UI -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden transform transition-all">
            <div class="bg-purple-600 text-white px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold flex items-center">
                        <i class="fas fa-share-alt mr-3"></i> Share Repository Report
                    </h3>
                    <button id="close-share-modal" class="text-white focus:outline-none hover:text-purple-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-5">
                    <p class="text-gray-700 mb-2">Share this free report with others:</p>
                    <p id="share-repo-name" class="font-bold text-lg text-gray-800"></p>
                </div>
                <div class="mb-6">
                    <label for="share-url" class="block text-sm font-medium text-gray-700 mb-1">Report Link</label>
                    <div class="relative rounded-md shadow-sm">
                        <input type="text" id="share-url" readonly 
                            class="border border-gray-300 focus:ring-purple-500 focus:border-purple-500 block w-full pr-10 py-3 px-4 rounded-md text-gray-900"
                            value="">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <button id="copy-share-url" class="text-purple-600 hover:text-purple-800 focus:outline-none">
                                <i class="far fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col space-y-3">
                    <button id="copy-button" class="w-full inline-flex justify-center items-center px-4 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                        <i class="far fa-copy mr-2"></i> Copy Link to Clipboard
                    </button>
                    
                    <button id="email-share-button" class="w-full inline-flex justify-center items-center px-4 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <i class="far fa-envelope mr-2"></i> Share via Email
                    </button>
                    
                    <div class="mt-2 pt-3 border-t border-gray-200">
                        <div class="flex justify-center space-x-4">
                            <button class="social-share-button" data-platform="linkedin">
                                <i class="fab fa-linkedin text-blue-700 text-2xl hover:text-blue-900"></i>
                            </button>
                            <button class="social-share-button" data-platform="reddit">
                                <i class="fab fa-reddit text-orange-600 text-2xl hover:text-orange-800"></i>
                            </button>
                            <button class="social-share-button" data-platform="whatsapp">
                                <i class="fab fa-whatsapp text-green-600 text-2xl hover:text-green-800"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="copy-success" class="hidden bg-green-100 text-green-700 px-6 py-3 text-center font-medium">
                <i class="fas fa-check mr-2"></i> Link copied to clipboard!
            </div>
        </div>
    </div>
    
    <!-- Full Report Coming Soon Modal -->
    <div id="coming-soon-modal">
        <div class="coming-soon-content">
            <span class="coming-soon-close">&times;</span>
            <h3><i class="fas fa-clock mr-2"></i>Coming Soon!</h3>
            <p class="mb-4">Paid detailed reports will be available in the near future.</p>
            <p class="text-sm text-gray-600 mb-4">Our team is working hard to bring you comprehensive repository analysis with advanced metrics and recommendations.</p>
            <button id="coming-soon-ok" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition-colors">
                Got it
            </button>
        </div>
    </div>
    
    <header class="bg-gray-800 text-white shadow-lg" style="background-color: #0000;">
        <div class="container mx-auto p-4 flex flex-row justify-between items-center">
            <div class="flex items-center">
                <img src="../static/icons/icon-192x192.png" alt="Repolizer Logo" class="w-10 h-10 mr-3 rounded-full">
                <h1 class="text-2xl font-bold hidden md:block"><a href="/">REPOLIZER</a></h1>
            </div>

            <!-- Search input with responsive width -->
            <div class="relative mx-2 flex-grow max-w-[150px] md:max-w-md">
                <input id="search-input" type="text" placeholder="Search..."
                       class="px-4 py-2 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                       style="font-weight: lighter; font-size: 0.9rem;">
                <i class="fas fa-search absolute right-3 top-2.5 text-white-600"></i>
            </div>

            <div class="flex items-center space-x-4">
                <a href="/" class="text-blue-300 flex items-center border-b-0 md:border-b-2 md:border-blue-300">
                    <i class="fas fa-home"></i>
                    <span class="hidden md:inline ml-1">Home</span>
                </a>
                {% if current_user.is_authenticated %}
                    <a href="/scraper" class="text-white hover:text-blue-300 transition-colors flex items-center">
                        <i class="fas fa-search"></i>
                        <span class="hidden md:inline ml-1">Scraper</span>
                    </a>
                    <a href="/analyze" class="text-white hover:text-blue-300 transition-colors flex items-center">
                        <i class="fas fa-chart-line"></i>
                        <span class="hidden md:inline ml-1">Analyzer</span>
                    </a>
                {% endif %}
                <a href="/stats" class="text-white hover:text-blue-300 transition-colors flex items-center">
                    <i class="fas fa-chart-pie"></i>
                    <span class="hidden md:inline ml-1">Statistics</span>
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow">
        <div id="mobile-notice" class="hidden mb-4 p-3 bg-blue-100 text-blue-800 rounded-md text-sm">
            <p><i class="fas fa-info-circle mr-1"></i> Mobile version: Showing limited repositories for better performance.</p>
        </div>

        <div id="safari-notice" class="hidden mb-4 p-3 bg-yellow-100 text-yellow-800 rounded-md text-sm">
            <p><i class="fas fa-exclamation-triangle mr-1"></i> Safari mobile detected: Using optimized mode for better performance.</p>
        </div>

        <div class="mb-6 flex justify-between items-center" style="display: none;"> <!-- Simple container for title and count -->
            <div class="text-sm text-gray-600">
                <span id="repo-count" class="font-semibold" style="color: white; font-size: large;">0</span><span class="font-semibold" style="color: white; font-size: normal;"> repositories</span>
            </div>
        </div>

        <div id="loading-indicator">
            <div class="spinner"></div>
            <span style="color: whitesmoke;font-weight:lighter;">Loading repositories...</span>
        </div>

        <!-- Virtual scrolling container for mobile - simplified for Safari -->
        <div id="virtual-scroll-container" class="hidden">
            <div id="virtual-scroll-content" class="pb-8"></div>
            <div id="scroll-loader" class="text-center py-4 hidden">
                <div class="spinner inline-block"></div>
                <span class="ml-2 text-white">Loading more...</span>
            </div>
        </div>

        <div id="repo-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Repository cards will be dynamically inserted here -->
        </div>

        <div id="no-results" class="hidden">
            <i class="fas fa-search text-gray-400 text-5xl mb-4"></i>
            <p class="text-xl text-gray-600">No repositories found matching your search criteria.</p>
        </div>

        <div id="load-error" class="hidden text-center py-8">
            <i class="fas fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
            <p class="text-xl text-white mb-4">We encountered an issue loading the repository data.</p>
            <button id="retry-load" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                <i class="fas fa-sync-alt mr-2"></i> Retry Loading
            </button>
        </div>
    </main>

    <footer class="bg-gray-800 text-white mt-auto py-6" style="background-color: rgba(31, 41, 55, 0.28);">
      <div class="container mx-auto px-4 text-center">
            <p style="font-weight: lighter; font-size: 0.9rem;">&copy; {{ current_year }} Repolizer</p> <!-- Use context variable -->
        </div>
    </footer>

    <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // Performance tracking
    const perfStart = performance.now();
    
    // Browser detection
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent) || 
                     (navigator.userAgent.includes('AppleWebKit') && 
                      !navigator.userAgent.includes('Chrome') && 
                      !navigator.userAgent.includes('Android'));
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isSafariIOS = isSafari && isIOS;
    
    // Apply Safari-specific optimizations
    if (isSafariIOS) {
        document.body.classList.add('safari-ios');
        document.getElementById('safari-notice')?.classList.remove('hidden');
        console.log('Safari iOS detected, applying special optimizations');
    }
    
    // Memory check for Safari
    let isLowMemory = false;
    if (isSafariIOS) {
        // Get device memory if available (not in Safari, but useful for other browsers)
        const deviceMemory = navigator.deviceMemory || 4; // Default to 4GB
        
        // Check if it's an older iOS device based on user agent
        const isOlderDevice = /iPhone OS ([0-9]|10|11)_/.test(navigator.userAgent);
        
        // Estimate if we're in a low memory condition
        isLowMemory = isOlderDevice || deviceMemory <= 2;
        
        if (isLowMemory) {
            document.body.classList.add('low-memory-mode');
            console.log('Low memory mode activated for Safari iOS');
        }
    }
    
    // Global variables
    let allRepos = [];
    let filteredRepos = [];
    let currentLanguage = 'all';
    let minScoreFilter = 0;
    let currentPage = 1;
    let reposPerPage = 30;
    let isLoadingData = false;
    let cachedRepositories = null;
    let isMobile = false;
    let loadAttempts = 0;
    const MAX_LOAD_ATTEMPTS = 3;
    let isVirtualScrolling = false;
    // Extra small limit for Safari iOS
    const MOBILE_REPO_LIMIT = isSafariIOS ? 20 : 30;
    const RENDER_BATCH_SIZE = isSafariIOS ? 3 : 5; // Smaller batch size for Safari
    let visibleItems = new Set();
    let lastScrollPosition = 0; // Track scroll position for Safari
    let scrollTimeout = null; // For debouncing scroll events in Safari
    
    // Virtual scrolling variables - simplified for Safari
    let virtualScrolling = {
        enabled: false,
        itemHeight: isSafariIOS ? 280 : 320, // Smaller size for Safari
        buffer: isSafariIOS ? 2 : 5, // Smaller buffer for Safari to reduce memory usage
        scrollTop: 0,
        viewportHeight: 0,
        totalHeight: 0,
        startIndex: 0,
        endIndex: 0,
        scheduledUpdate: null,
        // Safari specific
        useSimpleRendering: isSafariIOS,
        loadedItems: new Set()
    };
    
    // Mobile detection with Safari and battery optimization
    function checkIfMobile() {
        const isMobileDevice = window.innerWidth < 768 || 
               /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // For Safari iOS, just assume low power to be safe
        const isLowPower = isSafariIOS ? true : false;
        
        // For other browsers, try to detect battery status
        if (!isSafariIOS && 'getBattery' in navigator) {
            try {
                navigator.getBattery().then(battery => {
                    if (battery.level < 0.2 && !battery.charging) {
                        isLowPower = true;
                        console.log('Low battery detected, enabling extra power saving');
                    }
                });
            } catch (e) {
                console.log('Battery API not available or error:', e);
            }
        }
        
        return { isMobileDevice, isLowPower };
    }
    
    // Set initial mobile state and adjust settings
    function setupForMobileIfNeeded() {
        const { isMobileDevice, isLowPower } = checkIfMobile();
        isMobile = isMobileDevice;
        
        // Adjust settings for mobile
        if (isMobile) {
            // Extra conservative settings for Safari
            reposPerPage = isSafariIOS ? 5 : (isLowPower ? 5 : 10);
            document.getElementById('mobile-notice').classList.remove('hidden');
            
            // Enable virtual scrolling on mobile, with a different approach for Safari
            virtualScrolling.enabled = true;
            
            // Extra low power settings for Safari
            if (isLowPower || isSafariIOS) {
                document.body.classList.add('low-power-mode');
                virtualScrolling.itemHeight = isSafariIOS ? 200 : 260;
            }
            
            console.log(`Mobile device detected (Safari iOS: ${isSafariIOS}, low power: ${isLowPower}), optimizing for performance`);
        }
    }
    
    // Safari-optimized virtual scrolling setup
    function initVirtualScrolling() {
        if (!isMobile || !virtualScrolling.enabled) return;
        
        const repoGrid = document.getElementById('repo-grid');
        const virtualContainer = document.getElementById('virtual-scroll-container');
        const virtualContent = document.getElementById('virtual-scroll-content');
        
        if (!repoGrid || !virtualContainer || !virtualContent) return;
        
        // Hide standard grid, show virtual scrolling container
        repoGrid.classList.add('hidden');
        virtualContainer.classList.remove('hidden');
        
        // Set up scroll event handler with special handling for Safari
        let ticking = false;
        
        // Safari needs a simpler scroll handler to prevent lag
        if (isSafariIOS) {
            virtualContainer.addEventListener('scroll', () => {
                // Store the scroll position
                lastScrollPosition = virtualContainer.scrollTop;
                
                // Clear previous timeout if it exists
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                // Set a new timeout for delayed scroll handling (reduces frequent updates)
                scrollTimeout = setTimeout(() => {
                    virtualScrolling.scrollTop = lastScrollPosition;
                    updateVirtualScroll();
                }, 100); // Longer delay for Safari
            });
        } else {
            // Standard scroll handler for other browsers
            virtualContainer.addEventListener('scroll', () => {
                virtualScrolling.scrollTop = virtualContainer.scrollTop;
                
                if (!ticking) {
                    window.requestAnimationFrame(() => {
                        updateVirtualScroll();
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        }
        
        // Set initial viewport height
        virtualScrolling.viewportHeight = virtualContainer.clientHeight;
        
        // Simple approach for Safari - just load all visible items at once
        if (isSafariIOS) {
            // Instead of ResizeObserver which can cause issues in Safari
            window.addEventListener('resize', () => {
                virtualScrolling.viewportHeight = virtualContainer.clientHeight;
                updateVirtualScroll();
            });
            
            // Initial load
            setTimeout(() => {
                updateVirtualScroll();
            }, 100);
        } else {
            // ResizeObserver for other browsers
            try {
                const resizeObserver = new ResizeObserver(entries => {
                    for (const entry of entries) {
                        if (entry.target === virtualContainer) {
                            virtualScrolling.viewportHeight = entry.contentRect.height;
                            updateVirtualScroll();
                        }
                    }
                });
                
                resizeObserver.observe(virtualContainer);
            } catch (e) {
                console.error('ResizeObserver not supported:', e);
                // Fallback for browsers without ResizeObserver
                window.addEventListener('resize', () => {
                    virtualScrolling.viewportHeight = virtualContainer.clientHeight;
                    updateVirtualScroll();
                });
            }
        }
    }
    
    // Safari-optimized virtual scroll rendering
    function updateVirtualScroll() {
        if (!virtualScrolling.enabled || filteredRepos.length === 0) return;
        
        const virtualContainer = document.getElementById('virtual-scroll-container');
        const virtualContent = document.getElementById('virtual-scroll-content');
        
        if (!virtualContainer || !virtualContent) return;
        
        // For Safari iOS, use a much simpler approach - render all at once in batches
        if (isSafariIOS) {
            // If we've already rendered all items, don't re-render
            if (virtualScrolling.loadedItems.size >= filteredRepos.length) {
                return;
            }
            
            // For Safari, just render everything sequentially in small batches
            const startIdx = virtualScrolling.loadedItems.size;
            const endIdx = Math.min(startIdx + RENDER_BATCH_SIZE, filteredRepos.length);
            
            console.log(`Safari iOS: Rendering repos ${startIdx} to ${endIdx}`);
            
            // Render this batch
            for (let i = startIdx; i < endIdx; i++) {
                if (virtualScrolling.loadedItems.has(i)) continue;
                
                const repo = filteredRepos[i];
                const card = createMobileRepoCard(repo, i);
                card.setAttribute('data-index', i);
                
                // Simpler approach - just append in order
                virtualContent.appendChild(card);
                virtualScrolling.loadedItems.add(i);
                
                // Add a small delay between renders to prevent UI freezing
                setTimeout(() => {
                    card.classList.add('loaded');
                }, (i - startIdx) * 50);
            }
            
            // If we haven't loaded all items yet, schedule the next batch
            if (endIdx < filteredRepos.length) {
                setTimeout(() => {
                    updateVirtualScroll();
                }, RENDER_BATCH_SIZE * 100); // Delay based on batch size
            }
            
            return;
        }
        
        // Regular virtual scrolling for other browsers
        const scrollTop = virtualScrolling.scrollTop;
        const viewportHeight = virtualScrolling.viewportHeight;
        
        // Calculate visible range with buffer
        const startIndex = Math.max(0, Math.floor(scrollTop / virtualScrolling.itemHeight) - virtualScrolling.buffer);
        const endIndex = Math.min(
            filteredRepos.length - 1,
            Math.ceil((scrollTop + viewportHeight) / virtualScrolling.itemHeight) + virtualScrolling.buffer
        );
        
        // Skip update if visible range hasn't changed
        if (startIndex === virtualScrolling.startIndex && endIndex === virtualScrolling.endIndex) {
            return;
        }
        
        // Update indices
        virtualScrolling.startIndex = startIndex;
        virtualScrolling.endIndex = endIndex;
        
        // Update total height
        virtualScrolling.totalHeight = filteredRepos.length * virtualScrolling.itemHeight;
        
        // Clear existing content
        virtualContent.innerHTML = '';
        
        // Render visible items
        const visibleRepos = filteredRepos.slice(startIndex, endIndex + 1);
        visibleRepos.forEach((repo, idx) => {
            const actualIndex = startIndex + idx;
            const card = createMobileRepoCard(repo, actualIndex);
            card.style.transform = `translateY(${actualIndex * virtualScrolling.itemHeight}px)`;
            card.style.position = 'absolute';
            card.style.width = 'calc(100% - 16px)'; // Account for padding
            card.classList.add('progressive-load');
            virtualContent.appendChild(card);
            
            // Delayed fade in for smoother rendering
            setTimeout(() => {
                card.classList.add('loaded');
            }, idx * 20); // Stagger the animation
        });
        
        // Check if we're near the end and should load more
        const scrollThreshold = virtualScrolling.totalHeight - viewportHeight - 500; // 500px before the end
        if (scrollTop > scrollThreshold && !isLoadingData && filteredRepos.length < allRepos.length) {
            // Load more items
            console.log('Near end of scroll, loading more items...');
            loadMoreItems();
        }
    }
    
    // Load more items for infinite scrolling
    function loadMoreItems() {
        // This would normally load more from an API
        // For now, just simulate by showing a loading indicator
        const scrollLoader = document.getElementById('scroll-loader');
        if (scrollLoader) {
            scrollLoader.classList.remove('hidden');
            setTimeout(() => {
                scrollLoader.classList.add('hidden');
            }, 1000);
        }
    }
    
    // Safari-optimized mobile card creation
    function createMobileRepoCard(repo, index) {
        // For Safari, create an even simpler card with minimal DOM
        if (isSafariIOS) {
            const card = document.createElement('div');
            card.className = 'mobile-repo-card';
            card.setAttribute('data-index', index);
            
            const repoData = repo.repository || {};
            const repoId = repoData.id || '';
            const name = repoData.name || 'Unnamed Repository';
            const fullName = repoData.full_name || '';
            const stars = formatNumber(repoData.stargazers_count || 0);
            const overallScore = repo.overall_score || 0;
            
            // Ultra simple HTML structure for Safari
            card.innerHTML = `
                <div style="margin-bottom:8px;display:flex;justify-content:space-between">
                    <div>
                        <div style="font-weight:bold;color:#333">${name}</div>
                        <div style="font-size:12px;color:#666">${fullName}</div>
                    </div>
                    <div style="text-align:right;font-size:14px">⭐ ${stars}</div>
                </div>
                <div style="height:8px;background:#eee;border-radius:4px;margin-bottom:12px;overflow:hidden">
                    <div style="height:100%;background:${overallScore >= 70 ? '#34d399' : (overallScore >= 40 ? '#fbbf24' : '#f87171')};width:${overallScore}%"></div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:12px">
                    <a href="/repo/${repoId}" style="padding:4px 8px;background:#f3f4f6;border-radius:4px;font-size:14px">View Report</a>
                    <button class="share-button" data-repo-id="${repoId}" data-repo-name="${fullName}" style="padding:4px 8px;background:#8b5cf6;color:white;border-radius:4px;font-size:14px">Share</button>
                </div>
            `;
            
            // Simplified event listener
            const shareBtn = card.querySelector('.share-button');
            if (shareBtn) {
                shareBtn.onclick = function() {
                    openShareModal(this.getAttribute('data-repo-id'), this.getAttribute('data-repo-name'));
                };
            }
            
            return card;
        }
        
        // For other browsers, use the original card creation
        const repoData = repo.repository || {};
        const repoId = repoData.id || '';
        const card = document.createElement('div');
        card.className = 'mobile-repo-card';
        card.setAttribute('data-index', index);
        
        // Extract just the essential data
        const name = repoData.name || 'Unnamed Repository';
        const fullName = repoData.full_name || '';
        const stars = formatNumber(repoData.stargazers_count || 0);
        const language = repoData.language || '';
        const overallScore = repo.overall_score || 0;
        const scoreClass = overallScore >= 70 ? 'bg-green-500' : (overallScore >= 40 ? 'bg-yellow-500' : 'bg-red-500');
        
        // Create minimal HTML for better performance
        card.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h3 class="font-bold text-gray-800">${name}</h3>
                    <p class="text-xs text-gray-600">${fullName}</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-star text-yellow-400 mr-1"></i> ${stars}
                    </div>
                    ${language ? `<div class="text-xs text-gray-600 mt-1">${language}</div>` : ''}
                </div>
            </div>
            <div class="relative h-4 bg-gray-200 rounded-full overflow-hidden mb-3">
                <div class="absolute top-0 left-0 h-full ${scoreClass}" style="width: ${overallScore}%"></div>
            </div>
            <div class="flex justify-between mt-4">
                <a href="/repo/${repoId}" class="px-3 py-1 bg-gray-100 rounded text-sm">
                    View Report
                </a>
                <button type="button" class="share-button px-3 py-1 bg-purple-500 text-white rounded text-sm"
                        data-repo-id="${repoId}" data-repo-name="${fullName}">
                    Share
                </button>
            </div>
        `;
        
        // Add event listener to share button
        const shareBtn = card.querySelector('.share-button');
        if (shareBtn) {
            shareBtn.addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-repo-id');
                const name = e.currentTarget.getAttribute('data-repo-name');
                openShareModal(id, name);
            });
        }
        
        return card;
    }
    
    // Call mobile setup
    setupForMobileIfNeeded();
    
    // Get elements from the DOM
    const reposContainer = document.getElementById('repo-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noResults = document.getElementById('no-results');
    const repoCount = document.getElementById('repo-count');
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const languageFilterSelect = document.getElementById('language-filter-select');
    const scoreFilterSelect = document.getElementById('score-filter-select');
    const loadError = document.getElementById('load-error');
    const retryLoad = document.getElementById('retry-load');
    
    // Create pagination container at the bottom of the page
    const paginationContainer = document.createElement('div');
    paginationContainer.id = 'pagination-container';
    paginationContainer.className = 'flex justify-center my-6';
    reposContainer.parentNode.insertBefore(paginationContainer, reposContainer.nextSibling);

    // Check if all required DOM elements exist
    if (!reposContainer || !loadingIndicator || !noResults || !repoCount) {
      console.error('Required DOM elements not found.');
      return;
    }

    // Initialize virtual scrolling if on mobile
    if (isMobile && virtualScrolling.enabled) {
        initVirtualScrolling();
    }

    // Category icons and names - only load if not on mobile to save memory
    const categoryIcons = isMobile ? {} : {
        'documentation': 'fa-file-lines',
        'security': 'fa-shield-alt',
        'code_quality': 'fa-code',
        'performance': 'fa-tachometer-alt',
        'accessibility': 'fa-universal-access',
        'ci_cd': 'fa-sync',
        'maintainability': 'fa-wrench',
        'testing': 'fa-vial',
        'licensing': 'fa-balance-scale',
        'community': 'fa-users'
    };

    const categoryNames = isMobile ? {} : {
        'documentation': 'Documentation',
        'security': 'Security',
        'code_quality': 'Code Quality',
        'performance': 'Performance',
        'accessibility': 'Accessibility',
        'ci_cd': 'CI/CD',
        'maintainability': 'Maintainability',
        'testing': 'Testing',
        'licensing': 'Licensing',
        'community': 'Community'
    };

    // Use sessionStorage for very short-term caching on mobile
    // This will persist during the current session but clear when browser is closed
    function getCachedData() {
        try {
            // On mobile, check sessionStorage first for quicker access
            if (isMobile) {
                const sessionCached = sessionStorage.getItem('repolizerSessionRepos');
                if (sessionCached) {
                    const { data, timestamp } = JSON.parse(sessionCached);
                    // Only use session cache if it's less than 5 minutes old
                    if (Date.now() - timestamp < 5 * 60 * 1000) {
                        console.log('Using session cached repository data');
                        return data;
                    }
                }
            }
            
            // Fall back to localStorage for longer-term caching
            const cached = localStorage.getItem('repolizerRepositories');
            if (cached) {
                const { data, timestamp } = JSON.parse(cached);
                // Only use cache if it's less than 15 minutes old
                if (Date.now() - timestamp < 15 * 60 * 1000) {
                    console.log('Using localStorage cached repository data');
                    
                    // If on mobile, also update session storage for quicker future access
                    if (isMobile) {
                        try {
                            sessionStorage.setItem('repolizerSessionRepos', JSON.stringify({
                                data: data.slice(0, MOBILE_REPO_LIMIT),
                                timestamp: Date.now()
                            }));
                        } catch (e) {
                            console.warn('Failed to update sessionStorage:', e);
                        }
                    }
                    
                    return data;
                }
            }
        } catch (e) {
            console.warn('Failed to retrieve cached data:', e);
            clearCacheData(); // Clear potentially corrupted data
        }
        return null;
    }

    // Cache data in storage
    function cacheData(data) {
        try {
            // On mobile, only cache limited repos to avoid storage quota issues
            const dataToCache = isMobile ? data.slice(0, MOBILE_REPO_LIMIT) : data;
            
            // Save to localStorage for longer-term caching
            localStorage.setItem('repolizerRepositories', JSON.stringify({
                data: dataToCache,
                timestamp: Date.now()
            }));
            
            // On mobile, also save to sessionStorage for quicker access
            if (isMobile) {
                sessionStorage.setItem('repolizerSessionRepos', JSON.stringify({
                    data: dataToCache,
                    timestamp: Date.now()
                }));
            }
            
            console.log(`Cached ${dataToCache.length} repositories`);
        } catch (e) {
            console.warn('Failed to cache data:', e);
            clearCacheData(); // Clear storage if we hit quota limits
        }
    }
    
    // Clear cache data (used when errors occur)
    function clearCacheData() {
        try {
            localStorage.removeItem('repolizerRepositories');
            if (isMobile) sessionStorage.removeItem('repolizerSessionRepos');
        } catch (clearError) {
            console.error('Failed to clear storage:', clearError);
        }
    }

    // Get result path from parameters or use default
    const urlParams = new URLSearchParams(window.location.search);
    const resultPath = urlParams.get('path') || 'results.jsonl';
    const pageParam = urlParams.get('page');
    if (pageParam) {
      currentPage = parseInt(pageParam, 10) || 1;
    }
    
    console.log(`Loading repositories from: ${resultPath}, page ${currentPage}`);

    // Function to show error state
    function showError(message) {
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
            loadingIndicator.classList.add('hidden');
        }
        
        if (loadError) {
            const errorMsg = loadError.querySelector('p');
            if (errorMsg) {
                errorMsg.textContent = message || 'We encountered an issue loading the repository data.';
            }
            loadError.classList.remove('hidden');
        }
    }
    
    // Function to hide error state
    function hideError() {
        if (loadError) {
            loadError.classList.add('hidden');
        }
    }

    // Modified function to load repositories incrementally with improved mobile support
    async function loadRepositories() {
        if (isLoadingData) return;
        isLoadingData = true;
        hideError();
        
        // Record start time for performance measurement
        const loadStartTime = performance.now();
        
        try {
            loadAttempts++;
            
            // For Safari, try to load a very small sample dataset first
            if (isSafariIOS) {
                try {
                    // Check if we have a tiny sample file specifically for Safari
                    const safariSamplePath = 'sample_minimal.jsonl';
                    let response = await fetch(safariSamplePath);
                    
                    // If safari-specific sample exists, use it
                    if (response.ok) {
                        console.log('Loading Safari-optimized minimal sample data');
                        const text = await response.text();
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        const repoDataMap = {};
                        
                        // Process serially for Safari (no batching)
                        for (let i = 0; i < Math.min(lines.length, 15); i++) {
                            try {
                                if (lines[i].trim()) {
                                    const parsedRepo = JSON.parse(lines[i]);
                                    if (parsedRepo && parsedRepo.repository && parsedRepo.repository.id) {
                                        repoDataMap[parsedRepo.repository.id] = parsedRepo;
                                    }
                                }
                            } catch (e) {
                                console.warn(`Error parsing line ${i}:`, e);
                            }
                        }
                        
                        // Process and display
                        allRepos = Object.values(repoDataMap);
                        cacheData(allRepos);
                        processRepositoryData(allRepos);
                        console.log(`Safari quick load completed in ${((performance.now() - loadStartTime) / 1000).toFixed(2)}s`);
                        return;
                    }
                } catch (safariError) {
                    console.warn('Safari-specific sample loading failed:', safariError);
                }
            }
            
            // Continue with regular flow if Safari-specific approach failed
            
            // Check for cached data first (prioritizes sessionStorage on mobile)
            cachedRepositories = getCachedData();
            
            if (cachedRepositories) {
                processRepositoryData(cachedRepositories);
                console.log(`Loaded from cache in ${((performance.now() - loadStartTime) / 1000).toFixed(2)}s`);
                return;
            }
            
            // Show loading indicator
            if (loadingIndicator) {
                loadingIndicator.style.display = 'flex';
                loadingIndicator.classList.remove('hidden');
            }
            
            if (noResults) {
                noResults.classList.add('hidden');
            }
            
            // For mobile, try to fetch sample data first - much smaller dataset
            if (isMobile) {
                console.log('Mobile device detected, using simplified data loading');
                
                try {
                    // Try the sample data file first
                    const samplePath = 'sample_results.jsonl';
                    const response = await fetch(samplePath);
                    
                    if (response.ok) {
                        // Use a slower but more memory-efficient approach for mobile
                        const text = await response.text();
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        
                        // For mobile, only process a limited number of repositories
                        const maxLines = Math.min(lines.length, MOBILE_REPO_LIMIT);
                        const repoDataMap = {};
                        
                        // Process in batches to prevent UI freezing
                        const processBatch = async (startIdx, batchSize) => {
                            const endIdx = Math.min(startIdx + batchSize, maxLines);
                            
                            for (let i = startIdx; i < endIdx; i++) {
                                try {
                                    if (!lines[i].trim()) continue;
                                    
                                    const parsedRepo = JSON.parse(lines[i]);
                                    if (parsedRepo && parsedRepo.repository && parsedRepo.repository.id) {
                                        repoDataMap[parsedRepo.repository.id] = parsedRepo;
                                    }
                                } catch (e) {
                                    console.warn(`Error parsing line ${i}:`, e);
                                }
                            }
                            
                            // Update loading progress
                            if (loadingIndicator.querySelector('span')) {
                                loadingIndicator.querySelector('span').textContent = 
                                    `Loading repositories... (${endIdx}/${maxLines})`;
                            }
                            
                            // If we've processed all lines, finish up
                            if (endIdx >= maxLines) {
                                allRepos = Object.values(repoDataMap);
                                cacheData(allRepos);
                                processRepositoryData(allRepos);
                                console.log(`Mobile load completed in ${((performance.now() - loadStartTime) / 1000).toFixed(2)}s`);
                            } else {
                                // Otherwise, schedule the next batch with a small delay
                                setTimeout(() => {
                                    processBatch(endIdx, batchSize);
                                }, 10); // Brief pause to allow UI updates
                            }
                        };
                        
                        // Start processing in small batches
                        processBatch(0, 5);
                        return;
                    } else {
                        console.log('Sample data not found, falling back to main data');
                    }
                } catch (sampleError) {
                    console.warn('Error loading sample data:', sampleError);
                }
            }
            
            // If we reach here, either we're on desktop or sample data loading failed
            // Try loading from the main data source
            try {
                const response = await fetch(resultPath);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${resultPath}: ${response.status} ${response.statusText}`);
                }
                
                // For mobile, use a simpler but more memory-efficient approach
                if (isMobile) {
                    const text = await response.text();
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    
                    // For mobile, only process a limited number of repositories
                    const maxLines = Math.min(lines.length, MOBILE_REPO_LIMIT);
                    const repoDataMap = {};
                    
                    // Process in batches to prevent UI freezing
                    const processBatch = async (startIdx, batchSize) => {
                        const endIdx = Math.min(startIdx + batchSize, maxLines);
                        
                        for (let i = startIdx; i < endIdx; i++) {
                            try {
                                if (!lines[i].trim()) continue;
                                
                                const parsedRepo = JSON.parse(lines[i]);
                                if (parsedRepo && parsedRepo.repository && parsedRepo.repository.id) {
                                    repoDataMap[parsedRepo.repository.id] = parsedRepo;
                                }
                            } catch (e) {
                                console.warn(`Error parsing line ${i}:`, e);
                            }
                        }
                        
                        // Update loading progress
                        if (loadingIndicator.querySelector('span')) {
                            loadingIndicator.querySelector('span').textContent = 
                                `Loading repositories... (${endIdx}/${maxLines})`;
                        }
                        
                        // If we've processed all lines, finish up
                        if (endIdx >= maxLines) {
                            allRepos = Object.values(repoDataMap);
                            cacheData(allRepos);
                            processRepositoryData(allRepos);
                            console.log(`Mobile load from main file completed in ${((performance.now() - loadStartTime) / 1000).toFixed(2)}s`);
                        } else {
                            // Otherwise, schedule the next batch with a small delay
                            setTimeout(() => {
                                processBatch(endIdx, batchSize);
                            }, 10); // Brief pause to allow UI updates
                        }
                    };
                    
                    // Start processing in small batches
                    processBatch(0, 5);
                } else {
                    // For desktop, use the streaming approach
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let partialLine = '';
                    const repoDataMap = {};
                    
                    let processedLines = 0;
                    
                    const processChunk = async (result) => {
                        if (result.done) {
                            // Process any remaining partial line
                            if (partialLine.trim()) {
                                try {
                                    const parsedRepo = JSON.parse(partialLine);
                                    if (parsedRepo && parsedRepo.repository && parsedRepo.repository.id) {
                                        repoDataMap[parsedRepo.repository.id] = parsedRepo;
                                    }
                                } catch (e) {
                                    console.warn('Error parsing final line:', e);
                                }
                            }
                            
                            // Done reading the file
                            allRepos = Object.values(repoDataMap);
                            console.log(`Completed loading ${allRepos.length} repositories in ${((performance.now() - loadStartTime) / 1000).toFixed(2)}s`);
                            
                            // Cache the results
                            cacheData(allRepos);
                            
                            // Process the data
                            processRepositoryData(allRepos);
                            return;
                        }
                        
                        // Process this chunk
                        const chunk = decoder.decode(result.value, {stream: true});
                        const lines = (partialLine + chunk).split('\n');
                        partialLine = lines.pop() || ''; // Last line might be incomplete
                        
                        for (const line of lines) {
                            if (!line.trim()) continue;
                            
                            try {
                                const parsedRepo = JSON.parse(line);
                                if (parsedRepo && parsedRepo.repository && parsedRepo.repository.id) {
                                    repoDataMap[parsedRepo.repository.id] = parsedRepo;
                                    processedLines++;
                                    
                                    // Update UI every 100 lines
                                    if (processedLines % 100 === 0) {
                                        if (loadingIndicator.querySelector('span')) {
                                            loadingIndicator.querySelector('span').textContent = 
                                                `Loading repositories... (${processedLines} processed)`;
                                        }
                                        await new Promise(r => setTimeout(r, 0)); // Allow UI to update
                                    }
                                }
                            } catch (e) {
                                console.warn('Error parsing line:', e);
                            }
                        }
                        
                        // Continue reading
                        reader.read().then(processChunk);
                    };
                    
                    // Start stream reading for desktop
                    try {
                        await reader.read().then(processChunk);
                        return; // Exit function as processChunk will call processRepositoryData
                    } catch (streamError) {
                        console.error('Error during stream processing:', streamError);
                        throw streamError; // Re-throw to be caught by outer catch
                    }
                }
                
            } catch (mainError) {
                console.error('Error loading from main data source:', mainError);
                throw mainError; // Re-throw to be caught by outer catch
            }
            
            // Only for mobile or if we bypassed stream processing
            if (allRepos && allRepos.length > 0) {
                cacheData(allRepos);
                processRepositoryData(allRepos);
            }
            
        } catch (error) {
            console.error('Error loading repositories:', error);
            
            // Try fallback if main file fails
            if (resultPath !== 'repositories.jsonl' && loadAttempts <= MAX_LOAD_ATTEMPTS) {
                try {
                    console.log('Attempting to load fallback data...');
                    // ... existing fallback code ...
                } catch (fallbackError) {
                    console.error("Error fetching fallback data:", fallbackError);
                }
            }
            
            // Show error UI if all attempts failed
            showError(`Error loading repository data: ${error.message}`);
            isLoadingData = false;
        }
    } // Properly close loadRepositories function
    
    // Process repository data after loading - optimized for mobile
    function processRepositoryData(repos) {
        // ... existing code ...
    }
    
    // Start loading repositories
    loadRepositories();
    
    // ... existing code for retry button functionality ...
    
    // Function to display repositories
    function displayRepos() {
        if (!reposContainer) return;
        
        // ... existing display repositories code ...
    }
    
    // ... existing code for other functions ...
    
    // Clean up resources when page is hidden/unloaded
    document.addEventListener('visibilitychange', () => {
        // ... existing cleanup code ...
    });
  });
</script>
</body>
</html>